# This GitHub Actions workflow tracks and updates lifetime statistics for the KaliGPT repository.
# It fetches view and clone data from the GitHub API one's in a day for previous day and updates JSON files accordingly.
# The workflow runs on the 'hackerx' branch and commits changes back to the same branch.
# /KaliGPT/hackerx/.github/workflows/stats_tracker.yml

name: Lifetime Stats Tracker (HackerX)

on:
  schedule:
    - cron: '30 19 * * *' # Runs at 1:00 AM IST (19:30 UTC)
  workflow_dispatch:      # Allow manual trigger
  push:
      branches:
        - hackerx         # Only triggers on this branch

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: 'hackerx'  # Forces action to use the hackerx branch
      # INSTALL jq
      - name: Setup jq
        uses: dcarbone/install-jq-action@v2.1.0  # uses a reliable jq installer
        with:
          version: '1.6'  # specify a common version

      - name: Update Lifetime Stats
        id: fetch_stats
        run: |

          update_stat() {
            # store args data 
            DATA=$1    # data 
            FILE=$2    # file_name to store data
            LABEL=$3   # Label for the data
            COLOR=$4   # Color for showing data used

            # 1. Get the most recent day provided by GitHub API
            LATEST_ENTRY=$(echo "$DATA" | jq -c '.[-1]')
            DATA_COUNT=$(echo "$LATEST_ENTRY" | jq -r '.count // 0')
            DATA_TIMESTAMP=$(echo "$LATEST_ENTRY" | jq -r '.timestamp // ""')

            echo "Processing $LABEL: Last available day in API is $DATA_TIMESTAMP with $DATA_COUNT hits."


            # 2. Initialize file if it doesn't exist & get data if exist
            if [ ! -f "$FILE" ]; then
              echo "{\"schemaVersion\": 1, \"label\": \"$LABEL\", \"message\": \"0\", \"color\": \"$COLOR\", \"metadata\": { \"from\": \"2026-01-15T00:00:00Z\", \"upto\": \"\"}}" > "$FILE"
            fi

            LIFETIME=$(jq -r '.message' "$FILE")
            LAST_DAY_SAVED=$(jq -r '.metadata.upto' "$FILE")


            # 3. Only update if the date from GitHub is newer than our last saved date
            if [ "$DATA_TIMESTAMP" != "$LAST_DAY_SAVED" ] && [ "$DATA_TIMESTAMP" != "" ]; then
              NEW_LIFETIME=$((LIFETIME + DATA_COUNT))
              echo "New data detected. Updating lifetime to $NEW_LIFETIME."
            else
              NEW_LIFETIME=$LIFETIME
              echo "No new daily data found or day already processed. Skipping math."
            fi

            JSON_CONTENT="{\"schemaVersion\": 1, \"label\": \"$LABEL\", \"message\": \"$NEW_LIFETIME\", \"color\": \"$COLOR\",\"metadata\": { \"from\": \"2026-01-15T00:00:00Z\", \"upto\": \"$DATA_TIMESTAMP\"}}"
            echo "$JSON_CONTENT" > "$FILE"
          }
          
          echo "Fetching stats for SudoHopeX/KaliGPT..."
 
          # Fetch Views
          VIEWS_DATA=$(curl -s -H "Authorization: token ${{ secrets.CLONE_TOKEN }}" \
            "https://api.github.com/repos/SudoHopeX/KaliGPT/traffic/views")
          update_stat "$(echo "$VIEWS_DATA" | jq -r '.views')" "views_lifetime.json" "Total Views" "blue"
          
          # Fetch Clones
          CLONES_DATA=$(curl -s -H "Authorization: token ${{ secrets.CLONE_TOKEN }}" \
            "https://api.github.com/repos/SudoHopeX/KaliGPT/traffic/clones")
          update_stat "$(echo "$CLONES_DATA" | jq -r '.clones')" "clones_lifetime.json" "Total Clones" "brightgreen"

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "stats: update hackerx lifetime stats"
          branch: hackerx # Ensure it pushes back to hackerx
          file_pattern: "views_lifetime.json clones_lifetime.json"
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com
