# This GitHub Actions workflow tracks and updates lifetime statistics for the KaliGPT repository.
# It fetches view and clone data from the GitHub API every hour and updates JSON files accordingly.
# The workflow runs on the 'hackerx' branch and commits changes back to the same branch.
# /KaliGPT/.github/workflows/stats_tracker.yml

name: Lifetime Stats Tracker (HackerX)

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch:      # Allow manual trigger
  push:
      branches:
        - hackerx         # Only triggers on this branch

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: 'hackerx'  # Forces action to use the hackerx branch
      # INSTALL jq
      - name: Setup jq
        uses: dcarbone/install-jq-action@v2.1.0  # uses a reliable jq installer
        with:
          version: '1.6'  # specify a common version

      - name: Update Lifetime Stats
        id: fetch_stats
        run: |
          TODAY=$(date +%Y-%m-%dT00:00:00Z)
          echo "Targeting timestamp: $TODAY"

          update_stat() {
            # store args data 
            DATA=$1    # data 
            FILE=$2    # file_name to store data
            LABEL=$3   # Label for the data
            COLOR=$4   # Color for showing data used

            # DEBUG: See what data is being processed (check your Action logs!)
            echo "Processing $LABEL..."

            # DEBUG: see what data it gets
            echo "DATA: $DATA"

            TODAY_COUNT=$(echo "$DATA" | jq --arg TODAY "$TODAY" '.[] | select(.timestamp == $TODAY) | .count' | tail -n 1)
            
            # If TODAY_COUNT is empty (no hits yet today), set to 0
            if [ -z "$TODAY_COUNT" ]; then TODAY_COUNT=0; fi

            echo "Today's count for $LABEL: $TODAY_COUNT"

            if [ ! -f "$FILE" ]; then
              echo "{\"schemaVersion\": 1, \"label\": \"$LABEL\", \"message\": \"0\", \"color\": \"$COLOR\", \"lifetime\": 0, \"last_day\": \"\", \"today_so_far\": 0}" > "$FILE"
            fi

            LIFETIME=$(jq -r '.lifetime' "$FILE")
            LAST_DAY=$(jq -r '.last_day' "$FILE")
            SO_FAR=$(jq -r '.today_so_far' "$FILE")

            if [ "$TODAY" != "$LAST_DAY" ]; then
              # New day: Add today's total hits to the lifetime
              NEW_LIFETIME=$((LIFETIME + TODAY_COUNT))
            else
              # Same day: Only add the difference since the last run
              DIFF=$((TODAY_COUNT - SO_FAR))
              if [ "$DIFF" -lt 0 ]; then 
                  DIFF=0; 
              fi
              NEW_LIFETIME=$((LIFETIME + DIFF))
            fi

            LAST_UPDATED=$(date +"%Y-%m-%d %H:%M:%S")   

            JSON_CONTENT="{\"schemaVersion\": 1, \"label\": \"$LABEL\", \"message\": \"$NEW_LIFETIME\", \"color\": \"$COLOR\", \"lifetime\": \"$NEW_LIFETIME\", \"last_day\": \"$TODAY\", \"today_so_far\": \"$TODAY_COUNT\", \"last_updated\": \"$LAST_UPDATED\"}"
            echo "$JSON_CONTENT" > "$FILE"
          }
          
          echo "Fetching stats for SudoHopeX/KaliGPT..."
 
          # Fetch Views
          VIEWS_DATA=$(curl -s -H "Authorization: token ${{ secrets.CLONE_TOKEN }}" \
            "https://api.github.com/repos/SudoHopeX/KaliGPT/traffic/views")
          update_stat "$(echo "$VIEWS_DATA" | jq -r '.views')" "views_lifetime.json" "Total Views" "blue"
          
          # Fetch Clones
          CLONES_DATA=$(curl -s -H "Authorization: token ${{ secrets.CLONE_TOKEN }}" \
            "https://api.github.com/repos/SudoHopeX/KaliGPT/traffic/clones")
          update_stat "$(echo "$CLONES_DATA" | jq -r '.clones')" "clones_lifetime.json" "Total Clones" "brightgreen"

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "stats: update hackerx lifetime stats"
          branch: hackerx # Ensure it pushes back to hackerx
          file_pattern: "views_lifetime.json clones_lifetime.json"
          commit_user_name: GitHub Actions Bot
          commit_user_email: actions@github.com
